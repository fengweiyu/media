<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>MediaConvert.js demo</title>
  </head>

  <body>
    
    <script type="text/javascript" src="./build/MediaConvert.js"></script>
    <center>
        <h1><a href="">MediaConvert.js demo</a></h1>
        <input type="file" id="fileInput" accept=".flv,.h264,.h265"/>  
        <br><br>
        <button id="saveButton" disabled>格式转换</button>

        <h2>请选择一个输出格式:</h2>  
        <label>  
            <input type="checkbox" name="options" value="flv" > flv  
        </label>  
        <label>  
            <input type="checkbox" name="options" value="mp4" checked> mp4  
        </label>  
        <label>  
            <input type="checkbox" name="options" value="raw"> raw  
        </label>
        
        
    </center>

    <script>
        Module.onRuntimeInitialized = function() 
        {
            console.log('onRuntimeInitialized:'); 
        }
        // 获取所有复选框  
        const checkboxes = document.querySelectorAll('input[type="checkbox"][name="options"]');  

        checkboxes.forEach(checkbox => 
        {  
            checkbox.addEventListener('change', function() 
            {  
                if (this.checked) {  
                    // 如果当前复选框被选中，取消选中其他复选框  
                    checkboxes.forEach(cb => 
                    {  
                        if (cb !== this) 
                        {  
                            cb.checked = false; // 取消其他复选框的选中状态  
                        }  
                    });  
                }  
            });  
        });  
        const fileInput = document.getElementById('fileInput');  
        const saveButton = document.getElementById('saveButton');  
        let arrayBuffer;  
        let filename;
        let filetype;
        fileInput.addEventListener('change', function(event) 
        {  
            const file = event.target.files[0]; // 获取选中的文件  
            if (file) 
            {  
                const reader = new FileReader(); 
                var name=file.name;                
                const parts = name.split('.'); // 根据 . 分割文件名 
                filename=parts[0];
                filetype='.'+parts[1];
                //filename=name.substring(0, name.lastIndexOf('.')); 
                // 读取文件为 ArrayBuffer  
                reader.onload = function(e) 
                {  
                    arrayBuffer = e.target.result; // 将文件内容保存到 ArrayBuffer  
                    //console.log('File read as ArrayBuffer:', arrayBuffer);  
                    saveButton.disabled = false; // 启用保存按钮  
                    console.log('file:'+filename+' type:'+filetype+' byteLength:'+arrayBuffer.byteLength); 
                };  
                reader.readAsArrayBuffer(file); // 开始读取文件  
            }  
        });  
        saveButton.addEventListener('click', function() 
        {  
            if (!arrayBuffer)
            {
                console.log('file err:'+filename+' type:'+filetype+' byteLength:'+arrayBuffer.byteLength); 
                return;      
            }
            console.log('file addEventListener:'+filename+' type:'+filetype+' byteLength:'+arrayBuffer.byteLength);    
            // 选择所有的复选框  
            //Module.onRuntimeInitialized = function() 
            {
                convert();
            }
        }); 
        function convert() 
        {         
            const selectedHobbies = [];  
            // 遍历复选框，检测哪些被选中  
            checkboxes.forEach(checkbox => {  
                if (checkbox.checked) 
                {  
                    selectedHobbies.push(checkbox.value); // 添加到数组  
                }  
            }); 
            const dstType = '.'+selectedHobbies[0];
            /*const arr = new Float32Array([1.0, 2.0, 3.0]); // 示例数组  
            const size = arr.length * arr.BYTES_PER_ELEMENT; // 计算大小  
            const ptr = instance._malloc(size); // 在Wasm内存中申请空间  
            instance.HEAPF32.set(arr, ptr / arr.BYTES_PER_ELEMENT); // 拷贝数据到内存  
            instance._your_function(ptr, arr.length); // 调用C函数，传入数据指针和数组长度  
            instance._free(ptr); // 调用完后释放内存  */
            let arrDstType = intArrayFromString(dstType).concat(0);
	        let bufDstType = Module._malloc(arrDstType.length);
	        Module.HEAPU8.set(arrDstType, bufDstType);
	        let arrSrctype = intArrayFromString(filetype).concat(0);
	        let bufSrctype = Module._malloc(arrSrctype.length);
	        Module.HEAPU8.set(arrSrctype, bufSrctype);
            const uint8View = new Uint8Array(arrayBuffer);
	        let bufSrcFrame = Module._malloc(uint8View.byteLength);
	        Module.HEAPU8.set(uint8View,bufSrcFrame);//bufSrcFrame,arrayBuffer
            //const lengthPtr = Module._malloc(arrayBuffer.byteLength);
            //const uint8View = new Uint8Array(Module.HEAPU8.buffer, bufSrcFrame, arrayBuffer.byteLength).set(arrayBuffer);
            Module._InputData(bufSrcFrame,uint8View.byteLength,bufSrctype,bufDstType);
            //const buffer = new ArrayBuffer(arrayBuffer.byteLength); 
            //const uint8View = new Uint8Array(buffer); 
            let bufDstFrame = Module._malloc(uint8View.byteLength);
            var ret=0;
            var len=0; 
            do {  
                len+=ret;   
                ret = Module._GetData(bufDstFrame+len,uint8View.byteLength-len);//arrayBuffer.buffer arrayBuffer.byteOffset
            } while (ret>0); 
            let copiedArray = new Uint8Array(len);
            copiedArray.set(new Uint8Array(Module.HEAPU8.buffer, bufDstFrame, len)); // 将C中的数组拷贝到JS数组中
            Module._free(bufDstType);
            Module._free(bufSrctype);
            Module._free(bufSrcFrame);
            Module._free(bufDstFrame);
            // 创建 Blob 对象  
            const blob = new Blob([copiedArray]);  
            // 创建下载链接  
            const url = URL.createObjectURL(blob);  
            const a = document.createElement('a');  
            a.href = url;  
            a.download = filename+'.'+dstType; // 指定下载文件名  
            document.body.appendChild(a);  
            a.click(); // 自动点击下载链接  
            document.body.removeChild(a); // 下载后移除临时链接  

            // 释放 Blob URL  
            URL.revokeObjectURL(url);  
            
        } 
        function formatDate(date) 
        {  
            const currentDate = new Date();  
            const year = currentDate.getFullYear();  
            const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // 月份从0开始  
            const day = String(currentDate.getDate()).padStart(2, '0');  
            const hours = String(currentDate.getHours()).padStart(2, '0');  
            const minutes = String(currentDate.getMinutes()).padStart(2, '0');  
            const seconds = String(currentDate.getSeconds()).padStart(2, '0');  
            const milliseconds = String(currentDate.getMilliseconds()).padStart(3, '0');

            const formattedDate = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`; 
            return formattedDate;  
        } 
        //自执行函数：我们使用一个自执行函数来封装代码，确保不会污染全局命名空间
        (function() {  
            const originalLog = console.log;  

            console.log = function(...args) {  
                const now = new Date();  
                const timeStamp = formatDate(now);  //now.toISOString(); // 或者使用自定义格式  
                originalLog.apply(console, [`[${timeStamp}]`, ...args]);  
            };  
        })(); 
        
    </script>
  </body>
</html>
